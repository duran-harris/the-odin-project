<html>

<head>
  <title>Tic Tac Toe</title>
  <style>
      #gameBoard {
          display: grid;
          height: 600px;
          width: 600px;
          grid-template-rows: 200px 200px 200px;
          grid-template-columns: 200px 200px 200px;
          margin: auto;
          opacity: 0.2;
      }

      .gameTile {
          border: 1px solid black;
          background-color: lightskyblue;
      }

      .x {
          clip-path: polygon(0px 0px, 100px 100px, 200px 0px, 200px 200px, 100px 100px, 0px 200px)
      }

      .o {
          clip-path: circle(50% at 50% 50%);
      }

      #scoreBoard {
          display: flex;
          border: 1px solid black;
          justify-content: space-between;
          margin-bottom: 1.5rem;
      }
  </style>
</head>
<body>

<section id="scoreBoard">
  <div class="player-one">
    <div>
      <label for="player-one-name">
        Player One Name
      </label>
      <input id="player-one-name" type="text" value="Duran"/>
    </div>
    <div>
      Score: <span id="player-one-score">0</span>
    </div>
    <div>
      Symbol : <span id="player-one-icon">x</span>
    </div>
  </div>

  <div class="player-two">
    <div>
      <label for="player-two-name">
        Player Two Name
      </label>
      <input id="player-two-name" type="text" value="Duran's computer"/>
    </div>
    <div>
      Score: <span id="player-two-score">0</span>
    </div>
    <div>
      Symbol : <span id="player-two-icon">o</span>
    </div>
  </div>
</section>

<div id="gameBoard">
  <div class="gameTile">
  </div>
  <div class="gameTile">
  </div>
  <div class="gameTile">
  </div>

  <div class="gameTile">
  </div>
  <div class="gameTile">
  </div>
  <div class="gameTile">
  </div>

  <div class="gameTile">
  </div>
  <div class="gameTile">
  </div>
  <div class="gameTile">
  </div>
</div>

<script type="text/javascript">
    function createGameBoard() {
        let gameBoardTiles = [];
        let index = 0;
        for (let x = 0; x < 3; x++) {
            gameBoardTiles[x] = new Array(3);
            for (let y = 0; y < 3; y++) {
                gameBoardTiles[x][y] = createTile(x, y, index, null);
                index++;
            }
        }

        const getGameBoardTiles = () => gameBoardTiles;
        const storeMove = (x, y, pPlayer) => {
            console.log(`gameBoard.storeMove x=${x}, y=${y}, player=${pPlayer}`);
            gameBoardTiles[x][y].storeMove(pPlayer);
        };
        const isVacantTile = (x, y) => gameBoardTiles[x][y] == null;
        return {storeMove, isVacantTile, getGameBoardTiles};
    }

    function createTile(x, y, index, player) {
        const storeMove = (player) => {
            let element = document.querySelector(`.gameTile:nth-child(${index + 1})`);
            if (player != null) {
                element.classList.remove('o', 'x');
                element.classList.toggle(player.icon)
                gameController.getGameBoard().getGameBoardTiles()[x][y].player = player;
            }
        };
        return {x, y, index, player, storeMove};
    }

    const gameController = (function () {

        let playerOneName = document.getElementById("player-one-name").value
        let playerTwoName = document.getElementById("player-two-name").value

        let playerOneIcon = document.getElementById("player-one-icon").innerText
        let playerTwoIcon = document.getElementById("player-two-icon").innerText

        const playerOne = createPlayer(playerOneName, playerOneIcon);
        const playerTwo = createPlayer(playerTwoName, playerTwoIcon);
        let gameBoard = createGameBoard();
        let streaks = [];
        let activePlayer = playerOne;

        const getGameBoard = () => gameBoard;
        const getGameStates = () => Object.freeze({
            NOT_STARTED: "NOT_STARTED",
            IN_PROGRESS: "IN_PROGRESS",
            FINISHED: "FINISHED",
            PLAYER_ONE_WINS: "PLAYER_ONE_WINS",
            PLAYER_TWO_WINS: "PLAYER_TWO_WINS",
            STALEMATE: "STALEMATE"
        })

        let gameState = getGameStates().NOT_STARTED
        const setGameState = (state) => gameState = state;
        const endPlayerTurn = () => {
            console.log(`beginning endPlayerTurn: activePlayer = ${activePlayer.name}`);
            activePlayer === playerOne ? activePlayer = playerTwo : activePlayer = playerOne;
            console.log(`end endPlayerTurn: activePlayer = ${activePlayer.name}`);
        };

        const getStreaksForPlayer = (player) => {
            return streaks.filter(streak => streak.player === player);
        }

        const updateScore = () => {

            playerOne.score = getStreaksForPlayer(playerOne).length;
            playerTwo.score = getStreaksForPlayer(playerTwo).length;
            document.getElementById("player-one-score").innerText = playerOne.score;
            document.getElementById("player-two-score").innerText = playerTwo.score;
        };

        const getTilesInColumn = (columnIndex) => {
            console.log(`getTilesInColumn: ${columnIndex}`);
            let tiles = [];
            for (let x = 0; x < 3; x++) {
                for (let y = 0; y < 3; y++) {
                    if (x === columnIndex) {
                        let tile = gameController.getGameBoard().getGameBoardTiles()[x][y];
                        tiles.push(tile);
                    }
                }
            }
            console.log(`#getTilesInColumn(columnIndex):${columnIndex}`);
            console.log({tiles});
            return tiles;
        };

        const getTilesInRow = (rowIndex) => {
            let tiles = [];
            for (let x = 0; x < 3; x++) {
                for (let y = 0; y < 3; y++) {
                    if (y === rowIndex) {
                        let tile = gameController.getGameBoard().getGameBoardTiles()[x][y];
                        tiles.push(tile);
                    }
                }
            }

            console.log(`#getTilesInRow(rowIndex):${rowIndex}`);
            console.log(tiles);
            return tiles;
        }

        const getTilesInDiagonal = (x, y, diagonalDirection) => {

        }

        const processStreaks = () => {
            streaks = [];
            processVerticalStreaks();
            processHorizontalStreaks();
            processDiagonalStreaks();
        }

        const isStreak = (tileArray) => {

            console.log(`beginning isStreak: tileArray =`);
            console.log({tileArray});
            let players = tileArray.map(tile => tile.player);
            console.log(`isStreak players=`);
            console.log(players);
            return players[0] != null && players[0] === players[1] && players[1] === players[2];
        }

        const processVerticalStreaks = () => {

            let tilesInColumnOne = getTilesInColumn(0);
            let tilesInColumnTwo = getTilesInColumn(1);
            let tilesInColumnThree = getTilesInColumn(2);

            if (isStreak(tilesInColumnOne)) {
                console.log(`isVerticalStreak[column0]=true`);
                streaks.push(createStreak(tilesInColumnOne, tilesInColumnOne[0].player));
            }
            if (isStreak(tilesInColumnTwo)) {
                console.log(`isVerticalStreak[column1]=true`);
                streaks.push(createStreak(tilesInColumnTwo, tilesInColumnTwo[0].player));
            }
            if (isStreak(tilesInColumnThree)) {
                console.log(`isVerticalStreak[column2]=true`);
                streaks.push(createStreak(tilesInColumnThree, tilesInColumnThree[0].player));
            }
        }

        const processHorizontalStreaks = () => {
            let tilesInRowOne = getTilesInRow(0);
            let tilesInRowTwo = getTilesInRow(1);
            let tilesInRowThree = getTilesInRow(2);

            if (isStreak(tilesInRowOne)) {
                console.log(`isHorizontalStreak[row0]=true`);
                streaks.push(createStreak(tilesInRowOne, tilesInRowOne[0].player));
            }
            if (isStreak(tilesInRowTwo)) {
                console.log(`isHorizontalStreak[row1]=true`);
                streaks.push(createStreak(tilesInRowTwo, tilesInRowTwo[0].player));
            }
            if (isStreak(tilesInRowThree)) {
                console.log(`isHorizontalStreak[row2]=true`);
                streaks.push(createStreak(tilesInRowThree, tilesInRowThree[0].player));
            }
        }

        const processDiagonalStreaks = () => {

        }

        const createStreak = (tileArray, player) => {
            return {tileArray, player};
        }

        const getActivePlayer = () => activePlayer;
        const setActivePlayer = (player) => activePlayer = player;
        const storeMove = (x, y, player) => {
            console.log(`Storing move: x= ${x}, y = ${y}, player= ${player}`);
            getGameBoard().storeMove(x, y, player);
        };
        return {playerOne, playerTwo, getGameBoard, getGameStates, setGameState, endPlayerTurn, getActivePlayer, setActivePlayer, storeMove, updateScore, getTilesInColumn, getTilesInRow, processStreaks};
    })();

    function createPlayer(name, icon) {
        return {name, icon};
    }

    let tileNodeList = document.querySelectorAll('div.gameTile');

    for (let x = 1; x < 4; x++) {
        for (let y = 1; y < 4; y++) {
            let tile = gameController.getGameBoard().getGameBoardTiles()[x - 1][y - 1];
            console.log(`addEventListener on tile: index = ${tile.index + 1} tile.x=${tile.x}, tile.y=${tile.y} ,x=${x} , y=${y}  `);
            let element = tileNodeList[tile.index];

            element.addEventListener('click', function () {
                console.log(`onclick fired: tile.x =${tile.x}, tile.y=${tile.y}`);
                console.log(`onclick gameController.getActivePlayer() = ${gameController.getActivePlayer()}`);
                gameController.storeMove(tile.x, tile.y, gameController.getActivePlayer());
                gameController.processStreaks();
                gameController.updateScore();
                //If game not won yet end the current player's turn
                gameController.endPlayerTurn();
            });
        }
    }
</script>
</body>
</html>
