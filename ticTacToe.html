<html>
<head>
  <title>Tic Tac Toe</title>
  <style>
      :root {
          --player-one-color: red;
          --player-two-color: black;
      }

      #gameBoard {
          display: grid;
          height: 600px;
          width: 600px;
          grid-template-rows: 200px 200px 200px;
          grid-template-columns: 200px 200px 200px;
          margin: auto;
          opacity: 0.5;
      }

      .gameTile {
          border: 1px solid black;
          background-color: lightskyblue;
      }

      .x {
          fill: var(--player-one-color);
          opacity: 0.7;
          stroke: white;
          stroke-width: 1px;
      }

      .o {
          fill: var(--player-two-color);
          opacity: 0.7;
          stroke: white;
          stroke-width: 1px;
      }

      .player-one-icon-color {
          color: var(--player-one-color);
      }

      .player-two-icon-color {
          color: var(--player-two-color);
      }

      #scoreBoard {
          display: flex;
          border: 1px solid black;
          justify-content: space-between;
          margin-bottom: 1.5rem;
      }
  </style>
</head>
<body>
<section id="scoreBoard">
  <div class="player-one">
    <div>
      <label for="player-one-name">
        Player One Name
      </label>
      <input id="player-one-name" type="text" value="Duran"/>
    </div>
    <div>
      Score: <span id="player-one-score">0</span>
    </div>
    <div>
      Symbol : <span id="player-one-icon" class="player-one-icon-color">x</span>
    </div>
  </div>

  <div class="player-two">
    <div>
      <label for="player-two-name">
        Player Two Name
      </label>
      <input id="player-two-name" type="text" value="Duran's computer"/>
    </div>
    <div>
      Score: <span id="player-two-score">0</span>
    </div>
    <div>
      Symbol : <span id="player-two-icon" class="player-two-icon-color">o</span>
    </div>
  </div>
</section>


<div id="gameBoard">
  <div class="gameTile">
  </div>
  <div class="gameTile">
  </div>
  <div class="gameTile">
  </div>

  <div class="gameTile">
  </div>
  <div class="gameTile">
  </div>
  <div class="gameTile">
  </div>

  <div class="gameTile">
  </div>
  <div class="gameTile">
  </div>
  <div class="gameTile">
  </div>
</div>

<script type="text/javascript">
    function createGameBoard() {
        let gameBoardTiles = [];
        let index = 0;
        for (let x = 0; x < 3; x++) {
            gameBoardTiles[x] = new Array(3);
            for (let y = 0; y < 3; y++) {
                gameBoardTiles[x][y] = createTile(x, y, index, null);
                index++;
            }
        }
        const getGameBoardTiles = () => gameBoardTiles;
        const storeMove = (x, y, pPlayer) => {
            gameBoardTiles[x][y].storeMove(pPlayer);
        };
        const isVacantTile = (x, y) => gameBoardTiles[x][y] == null;
        return {storeMove, isVacantTile, getGameBoardTiles};
    }

    function createTile(x, y, index, player) {
        const storeMove = (player) => {
            let element = document.querySelector(`.gameTile:nth-child(${index + 1})`);
            if (player != null) {
                element.innerHTML = player.icon;
                gameController.getGameBoard().getGameBoardTiles()[x][y].player = player;
            }
        };
        return {x, y, index, player, storeMove};
    }

    const gameController = (function () {

        let playerOneName = document.getElementById("player-one-name").value
        let playerTwoName = document.getElementById("player-two-name").value

        let playerOneIcon = `<svg class="x-svg" width="200" height="200"><path d="M 0 0 L 100 100 L 200 0 L 200 200 L 100 100 L 0 200" class="x"/></svg>`;
        let playerTwoIcon = `<svg class="circle-svg" width="200" height="200"><circle cx="100" cy="100" r="100" class="o"/></svg>`;

        const playerOne = createPlayer(playerOneName, playerOneIcon);
        const playerTwo = createPlayer(playerTwoName, playerTwoIcon);
        let gameBoard = createGameBoard();
        let streaks = [];
        let activePlayer = playerOne;

        const getGameBoard = () => gameBoard;
        const getGameStates = () => Object.freeze({
            NOT_STARTED: "NOT_STARTED",
            IN_PROGRESS: "IN_PROGRESS",
            FINISHED: "FINISHED",
            PLAYER_ONE_WINS: "PLAYER_ONE_WINS",
            PLAYER_TWO_WINS: "PLAYER_TWO_WINS",
            STALEMATE: "STALEMATE"
        })

        let gameState = getGameStates().NOT_STARTED
        const setGameState = (state) => gameState = state;
        const endPlayerTurn = () => {
            activePlayer === playerOne ? activePlayer = playerTwo : activePlayer = playerOne;
        };

        const getStreaksForPlayer = (player) => {
            return streaks.filter(streak => streak.player === player);
        }

        const updateScore = () => {
            playerOne.score = getStreaksForPlayer(playerOne).length;
            playerTwo.score = getStreaksForPlayer(playerTwo).length;
            document.getElementById("player-one-score").innerText = playerOne.score;
            document.getElementById("player-two-score").innerText = playerTwo.score;
        };

        const getTilesInColumn = (columnIndex) => {
            let tiles = [];
            for (let x = 0; x < 3; x++) {
                for (let y = 0; y < 3; y++) {
                    if (x === columnIndex) {
                        let tile = gameController.getGameBoard().getGameBoardTiles()[x][y];
                        tiles.push(tile);
                    }
                }
            }
            return tiles;
        };

        const getTilesInRow = (rowIndex) => {
            let tiles = [];
            for (let x = 0; x < 3; x++) {
                for (let y = 0; y < 3; y++) {
                    if (y === rowIndex) {
                        let tile = gameController.getGameBoard().getGameBoardTiles()[x][y];
                        tiles.push(tile);
                    }
                }
            }
            return tiles;
        }

        const getTilesInDiagonal = (x1, y1, x2, y2, x3, y3) => {
            let tiles = [];
            let tileOne = gameController.getGameBoard().getGameBoardTiles()[x1][y1];
            let tileTwo = gameController.getGameBoard().getGameBoardTiles()[x2][y2];
            let tileThree = gameController.getGameBoard().getGameBoardTiles()[x3][y3];
            tiles = tiles.concat(tileOne, tileTwo, tileThree);
            return tiles;
        }

        const processStreaks = () => {
            streaks = [];
            processVerticalStreaks();
            processHorizontalStreaks();
            processDiagonalStreaks();
        }

        const isStreak = (tileArray) => {
            let players = tileArray.map(tile => tile.player);
            return players[0] != null && players[0] === players[1] && players[1] === players[2];
        }

        const processVerticalStreaks = () => {
            let tilesInColumnOne = getTilesInColumn(0);
            let tilesInColumnTwo = getTilesInColumn(1);
            let tilesInColumnThree = getTilesInColumn(2);

            if (isStreak(tilesInColumnOne)) {
                streaks.push(createStreak(tilesInColumnOne, tilesInColumnOne[0].player));
            }
            if (isStreak(tilesInColumnTwo)) {
                streaks.push(createStreak(tilesInColumnTwo, tilesInColumnTwo[0].player));
            }
            if (isStreak(tilesInColumnThree)) {
                streaks.push(createStreak(tilesInColumnThree, tilesInColumnThree[0].player));
            }
        }

        const processHorizontalStreaks = () => {
            let tilesInRowOne = getTilesInRow(0);
            let tilesInRowTwo = getTilesInRow(1);
            let tilesInRowThree = getTilesInRow(2);

            if (isStreak(tilesInRowOne)) {
                streaks.push(createStreak(tilesInRowOne, tilesInRowOne[0].player));
            }
            if (isStreak(tilesInRowTwo)) {
                streaks.push(createStreak(tilesInRowTwo, tilesInRowTwo[0].player));
            }
            if (isStreak(tilesInRowThree)) {
                streaks.push(createStreak(tilesInRowThree, tilesInRowThree[0].player));
            }
        }

        const processDiagonalStreaks = () => {
            let tilesInLeftToRightDiagonal = getTilesInDiagonal(0, 2, 1, 1, 2, 0)
            let tilesInRightToLeftDiagonal = getTilesInDiagonal(0, 0, 1, 1, 2, 2);

            if (isStreak(tilesInLeftToRightDiagonal)) {
                streaks.push(createStreak(tilesInLeftToRightDiagonal, tilesInLeftToRightDiagonal[0].player));
            }
            if (isStreak(tilesInRightToLeftDiagonal)) {
                streaks.push(createStreak(tilesInRightToLeftDiagonal, tilesInRightToLeftDiagonal[0].player));
            }
        }

        const createStreak = (tileArray, player) => {
            return {tileArray, player};
        }

        const getActivePlayer = () => activePlayer;
        const setActivePlayer = (player) => activePlayer = player;
        const storeMove = (x, y, player) => {
            console.log(`Storing move: x= ${x}, y = ${y}, player= ${player}`);
            getGameBoard().storeMove(x, y, player);
        };
        return {playerOne, playerTwo, getGameBoard, getGameStates, setGameState, endPlayerTurn, getActivePlayer, setActivePlayer, storeMove, updateScore, getTilesInColumn, getTilesInRow, processStreaks};
    })();

    function createPlayer(name, icon) {
        return {name, icon};
    }

    let tileNodeList = document.querySelectorAll('div.gameTile');

    for (let x = 1; x < 4; x++) {
        for (let y = 1; y < 4; y++) {
            let tile = gameController.getGameBoard().getGameBoardTiles()[x - 1][y - 1];
            console.log(`addEventListener on tile: index = ${tile.index + 1} tile.x=${tile.x}, tile.y=${tile.y} ,x=${x} , y=${y}  `);
            let element = tileNodeList[tile.index];

            element.addEventListener('click', function () {
                console.log(`onclick fired: tile.x =${tile.x}, tile.y=${tile.y}`);
                console.log(`onclick gameController.getActivePlayer() = ${gameController.getActivePlayer()}`);
                gameController.storeMove(tile.x, tile.y, gameController.getActivePlayer());
                gameController.processStreaks();
                gameController.updateScore();
                //If game not won yet end the current player's turn
                gameController.endPlayerTurn();
            });
        }
    }
</script>
</body>
</html>
