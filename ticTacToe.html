<html>

<head>
  <title>Tic Tac Toe</title>
  <style>
      :root {
          --player-one-color: red;
          --player-two-color: blue;
          --score-board-height: 3rem;
      }


      #gameBoard {
          display: grid;
          height: 100%;
          width: 100%;
          grid-template-rows: 0.8fr 0.8fr 0.8fr;
          grid-template-columns: 0.8fr 0.8fr 0.8fr;
          margin: 0.3fr;
      }

      .gameTile {
          z-index: 2;
          border: 2px solid black;
          background-color: lightskyblue;
          opacity: 0.2;
          position: relative;
      }

      .gameTile-icon {
          position: absolute !important;
          left: 50%;
          top: 50% !important;
      }

      #scoreBoard {
          display: flex;
          border: 1px solid black;
          justify-content: space-between;
          margin-bottom: 1.5rem;
      }
  </style>

</head>

<body>

<section id="scoreBoard">
  <div class="player-one">
    <div>
      <label for="player-one-name">
        Player One Name
      </label>
      <input id="player-one-name" type="text" value="Duran"/>
    </div>
    <div>
      Score: <span id="player-one-score">0</span>
    </div>
    <div>
      Symbol : <span id="player-one-icon">X</span>
    </div>
  </div>

  <div class="player-two">
    <div>
      <label for="player-two-name">
        Player Two Name
      </label>
      <input id="player-two-name" type="text" value="Duran's computer"/>
    </div>
    <div>
      Score: <span id="player-two-score">0</span>
    </div>
    <div>
      Symbol : <span id="player-two-icon">O</span>
    </div>
  </div>
</section>

<div id="gameBoard">
  <div class="gameTile">
    <div class="gameTile-icon"></div>
  </div>
  <div class="gameTile">
    <div class="gameTile-icon"></div>
  </div>
  <div class="gameTile">
    <div class="gameTile-icon"></div>
  </div>

  <div class="gameTile">
    <div class="gameTile-icon"></div>
  </div>
  <div class="gameTile">
    <div class="gameTile-icon"></div>
  </div>
  <div class="gameTile">
    <div class="gameTile-icon"></div>
  </div>

  <div class="gameTile">
    <div class="gameTile-icon"></div>
  </div>
  <div class="gameTile">
    <div class="gameTile-icon"></div>
  </div>
  <div class="gameTile">
    <div class="gameTile-icon"></div>
  </div>

</div>

<script type="text/javascript">


    function createGameBoard() {
        let gameBoardTiles = [];
        let index = 0;
        for (let x = 0; x < 3; x++) {
            gameBoardTiles[x] = new Array(3);
            for (let y = 0; y < 3; y++) {
                gameBoardTiles[x][y] = createTile(x, y, index, null);
                index++;
            }
        }

        const getGameBoardTiles = () => gameBoardTiles;
        const storeMove = (x, y, pPlayer) => {
            console.log(`gameBoard.storeMove x=${x}, y=${y}`);
            gameBoardTiles[x][y].storeMove(pPlayer);
        };

        const isVacantTile = (x, y) => gameBoardTiles[x][y] == null;
        const render = () => {
            for (let x = 0; x < 3; x++) {
                for (let y = 0; y < 3; y++) {
                    gameBoardTiles[x][y].render();
                }
            }
        }
        const renderTile = (x, y) => gameBoardTiles[x][y].render();
        return {storeMove, isVacantTile, getGameBoardTiles, render, renderTile};
    }

    function createTile(x, y, index, player) {

        const render = () => {

            if (this.player != null && x != null && y != null) {
                document.querySelector(`.gameTile:nth-child(${index + 1})`).innerHTML = this.player.icon;
            }
        };
        const storeMove = (pPlayer) => {
            this.player = pPlayer;
        };

        return {x, y, index, player, render, storeMove};
    }


    const gameController = (function () {

        let playerOneName = document.getElementById("player-one-name").value
        let playerTwoName = document.getElementById("player-two-name").value

        let playerOneIcon = document.getElementById("player-one-icon").innerText
        let playerTwoIcon = document.getElementById("player-two-icon").innerText

        const playerOne = createPlayer(playerOneName, playerOneIcon);
        const playerTwo = createPlayer(playerTwoName, playerTwoIcon);
        const gameBoard = createGameBoard();

        let activePlayer = playerOne;

        const getGameBoard = () => gameBoard;
        const getGameStates = () => Object.freeze({
            NOT_STARTED: "NOT_STARTED",
            IN_PROGRESS: "IN_PROGRESS",
            FINISHED: "FINISHED",
            PLAYER_ONE_WINS: "PLAYER_ONE_WINS",
            PLAYER_TWO_WINS: "PLAYER_TWO_WINS",
            STALEMATE: "STALEMATE"
        })

        let gameState = getGameStates().NOT_STARTED

        const setGameState = (state) => gameState = state;

        const renderGameBoard = () => {
            gameBoard.render();
        };

        const renderTile = (x, y) => {
            gameBoard.renderTile(x, y);
        };

        const endPlayerTurn = () => {
            activePlayer === playerOne ? activePlayer = playerTwo : activePlayer = playerOne;
        };

        const updateScore = () => {

        };

        const getTilesInColumn = (columnIndex) => {
            let tiles = [];
            for (let x = 0; x < 3; x++) {
                for (let y = 0; y < 3; y++) {
                    if (x === columnIndex) {
                        let tile = gameController.getGameBoard().getGameBoardTiles()[x][y];
                        tiles.push(tile);
                    }
                }
            }
            return tiles;
        };

        const getTilesInRow = (rowIndex) => {

            let tiles = [];
            for (let x = 0; x < 3; x++) {
                for (let y = 0; y < 3; y++) {
                    if (y === rowIndex) {
                        let tile = gameController.getGameBoard().getGameBoardTiles()[x][y];
                        tiles.push(tile);
                    }
                }
            }
            return tiles;
        }

        const getTilesInDiagonal = (x, y, diagonalDirection) => {

        }

        const processStreaks = () => {
            processVerticalStreaks();
            processHorizontalStreaks();
            processDiagonalStreaks();
        }

        const isStreak = (tileArray) => {
            let players = tileArray.map(tile => tile.player);
            return players[0] != null && players[0] === players[1] && players[1] === players[2];
        }

        const processVerticalStreaks = () => {

            console.log(`isVerticalStreak[column0]=${isStreak(getTilesInColumn(0))}`);
            console.log(`isVerticalStreak[column1]=${isStreak(getTilesInColumn(1))}`);
            console.log(`isVerticalStreak[column2]=${isStreak(getTilesInColumn(2))}`);

        }

        const processHorizontalStreaks = () => {
            console.log(`isHorizontalStreak[row0]=${isStreak(getTilesInRow(0))}`);
            console.log(`isHorizontalStreak[row1]=${isStreak(getTilesInRow(1))}`);
            console.log(`isHorizontalStreak[row2]=${isStreak(getTilesInRow(2))}`);
        }

        const processDiagonalStreaks = () => {

        }

        const getActivePlayer = () => activePlayer;
        const setActivePlayer = (player) => activePlayer = player;
        const storeMove = (x, y, player) => {
            console.log(`Storing move: x= ${x}, y = ${y}`);
            getGameBoard().storeMove(x, y, player);
        };

        return {playerOne, playerTwo, getGameBoard, getGameStates, setGameState, renderGameBoard, renderTile, endPlayerTurn, getActivePlayer, setActivePlayer, storeMove, updateScore, getTilesInColumn, getTilesInRow, processStreaks};

    })();


    gameController.renderGameBoard();

    function createStreak(streakStart, streakMiddle, streakEnd) {
        return {streakStart, streakMiddle, streakEnd};
    }

    function createPlayer(name, icon) {
        const playerMovements = [];
        const playerStreaks = [];
        return {name, icon, playerMovements, playerStreaks};
    }


    let tileNodeList = document.querySelectorAll('div.gameTile');

    for (let x = 1; x < 4; x++) {

        for (let y = 1; y < 4; y++) {

            let tile = gameController.getGameBoard().getGameBoardTiles()[x - 1][y - 1];
            console.log(`addEventListener on tile: index = ${tile.index + 1} tile.x=${tile.x}, tile.y=${tile.y} ,x=${x} , y=${y}  `);
            let element = tileNodeList[tile.index];
            element.addEventListener('click', function () {

                console.log(`onclick fired: tile.x =${tile.x}, tile.y=${tile.y}`);

                if (tile.player == null) {
                    gameController.storeMove(tile.x, tile.y, gameController.getActivePlayer());
                    gameController.renderTile(tile.x, tile.y);
                    gameController.processStreaks();
                    //gameController.updateScore();
                    //If game not won yet end the current player's turn
                    gameController.endPlayerTurn();
                }

            });
        }
    }


</script>
</body>
</html>
